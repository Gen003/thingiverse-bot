import telegram
import requests
import asyncio
import os
import sys
import logging
from datetime import datetime, timedelta

# --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø¬Ù„Ø§Øª (Logging) ---
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.StreamHandler(sys.stdout)
    ]
)
logger = logging.getLogger('Thingiverse_Monitor')

# --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆÙ‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ---
BOT_TOKEN = os.environ.get('BOT_TOKEN')
CHANNEL_ID = os.environ.get('CHANNEL_ID')
THINGIVERSE_APP_TOKEN = os.environ.get('APP_TOKEN')  # Ù…ÙØªØ§Ø­ API Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ Thingiverse

if not BOT_TOKEN or not CHANNEL_ID or not THINGIVERSE_APP_TOKEN:
    logger.critical("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©! ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹ÙŠÙŠÙ† BOT_TOKEN, CHANNEL_ID Ùˆ APP_TOKEN.")
    sys.exit(1)

SENT_LINKS_FILE = 'sent_links.txt'
bot = telegram.Bot(token=BOT_TOKEN)

# --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ---
def load_sent_links():
    try:
        if not os.path.exists(SENT_LINKS_FILE):
            return set()
        with open(SENT_LINKS_FILE, 'r', encoding='utf-8') as f:
            return set(line.strip() for line in f)
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø±Ø³Ù„Ø©: {e}")
        return set()

def save_sent_link(link):
    try:
        with open(SENT_LINKS_FILE, 'a', encoding='utf-8') as f:
            f.write(link + '\n')
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø±Ø§Ø¨Ø·: {e}")

# --- Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ØºÙŠØ± Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø© ---
async def send_to_telegram(item):
    try:
        # ØªØ­Ø¶ÙŠØ± Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        message = (
            f"<b>ğŸ¯ ØªØµÙ…ÙŠÙ… Ø¬Ø¯ÙŠØ¯ Ø¹Ù„Ù‰ Thingiverse!</b>\n\n"
            f"<b>ğŸ·ï¸ Ø§Ù„Ø§Ø³Ù…:</b> {item['name']}\n"
            f"<b>ğŸ‘¤ Ø§Ù„Ù…ØµÙ…Ù…:</b> {item['creator']['name']}\n"
            f"<b>ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø´Ø±:</b> {item['added']}\n"
            f"<b>ğŸ”— Ø§Ù„Ø±Ø§Ø¨Ø·:</b> <a href='{item['public_url']}'>Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ù„ØªØ­Ù…ÙŠÙ„</a>"
        )
        
        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØµÙˆØ±Ø© Ù…Ù†Ø§Ø³Ø¨Ø© (Ø£ÙˆÙ„ ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)
        image_url = None
        for image in item.get('images', []):
            if image.get('sizes') and image['sizes'][0].get('url'):
                image_url = image['sizes'][0]['url']
                break
        
        # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø¹ Ø§Ù„ØµÙˆØ±Ø© (Ø£Ùˆ Ø¨Ø¯ÙˆÙ†Ù‡Ø§)
        if image_url:
            await bot.send_photo(
                chat_id=CHANNEL_ID,
                photo=image_url,
                caption=message,
                parse_mode=telegram.ParseMode.HTML
            )
            logger.info(f"ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù…Ø¹ Ø§Ù„ØµÙˆØ±Ø©: {item['name']}")
        else:
            await bot.send_message(
                chat_id=CHANNEL_ID,
                text=message,
                parse_mode=telegram.ParseMode.HTML
            )
            logger.info(f"ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø¯ÙˆÙ† ØµÙˆØ±Ø©: {item['name']}")
            
        return True
        
    except Exception as e:
        logger.error(f"ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬: {e}")
        return False

# --- Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„ØªØµÙ…ÙŠÙ…Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Thingiverse API ---
async def fetch_new_models(sent_links):
    logger.info("Ø¬Ø§Ø±Ù Ø¬Ù„Ø¨ Ø§Ù„ØªØµÙ…ÙŠÙ…Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Thingiverse API...")
    try:
        # Ø­Ø³Ø§Ø¨ ÙˆÙ‚Øª Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« (Ø¢Ø®Ø± 10 Ø¯Ù‚Ø§Ø¦Ù‚)
        last_check_time = datetime.utcnow() - timedelta(minutes=10)
        formatted_time = last_check_time.strftime('%Y-%m-%d %H:%M:%S')
        
        # Ø¥Ø¹Ø¯Ø§Ø¯ Ø·Ù„Ø¨ API
        url = f'https://api.thingiverse.com/search/?added_after={formatted_time}&type=things&sort=newest&per_page=20'
        headers = {
            'Authorization': f'Bearer {THINGIVERSE_APP_TOKEN}',
            'Accept': 'application/json'
        }
        
        # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
        response = requests.get(url, headers=headers, timeout=25)
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø¬Ø§Ø­ Ø§Ù„Ø·Ù„Ø¨
        if response.status_code != 200:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ API: {response.status_code} - {response.text}")
            return []
        
        # ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        data = response.json()
        new_items = []
        
        for item in data.get('hits', []):
            # Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„ØªØµÙ…ÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø© Ø³Ø§Ø¨Ù‚Ø§Ù‹
            if item.get('public_url') and item['public_url'] not in sent_links:
                new_items.append(item)
        
        logger.info(f"ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ {len(new_items)} ØªØµÙ…ÙŠÙ… Ø¬Ø¯ÙŠØ¯")
        return new_items
        
    except Exception as e:
        logger.error(f"ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„ØªØµÙ…ÙŠÙ…Ø§Øª: {e}")
        return []

# --- Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ---
async def main():
    logger.info("--- Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø¨ÙˆØª Ù…Ø±Ø§Ù‚Ø¨Ø© Thingiverse ---")
    
    try:
        await bot.send_message(
            chat_id=CHANNEL_ID,
            text="ğŸš€ Ø¨Ø¯Ø£ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¹Ù„Ù‰ Thingiverse..."
        )
    except Exception as e:
        logger.error(f"ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¨Ø¯Ø¡: {e}")

    sent_links = load_sent_links()
    logger.info(f"ØªÙ… ØªØ­Ù…ÙŠÙ„ {len(sent_links)} Ø±Ø§Ø¨Ø· Ù…Ø±Ø³Ù„ Ø³Ø§Ø¨Ù‚Ø§Ù‹")

    while True:
        try:
            # Ø¬Ù„Ø¨ Ø§Ù„ØªØµÙ…ÙŠÙ…Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            new_models = await fetch_new_models(sent_links)
            
            # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØµÙ…ÙŠÙ…Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            for model in new_models:
                if await send_to_telegram(model):
                    sent_links.add(model['public_url'])
                    save_sent_link(model['public_url'])
                    await asyncio.sleep(1)  # ÙØ§ØµÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
            
            # Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
            interval = 300  # 5 Ø¯Ù‚Ø§Ø¦Ù‚
            logger.info(f"ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„Ø¯ÙˆØ±Ø© - Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± {interval//60} Ø¯Ù‚Ø§Ø¦Ù‚")
            await asyncio.sleep(interval)
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©: {e}")
            await asyncio.sleep(60)  # Ø§Ù†ØªØ¸Ø§Ø± Ù‚ØµÙŠØ± Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©

if __name__ == '__main__':
    try:
        asyncio.run(main())
    except (KeyboardInterrupt, SystemExit):
        logger.info("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª ÙŠØ¯ÙˆÙŠÙ‹Ø§")
    except Exception as e:
        logger.critical(f"Ø§Ù†Ù‡ÙŠØ§Ø± ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: {e}")